import { Point, Sprite, Container } from 'pixi.js';
import * as input from 'engine/input';

export class Head {
    constructor(pos, container) {
        this.container = new Container;
        container.addChild(this.container);

        this.sprite = this.createSprite("head", container);
        this.sprite.scale.set(0.4, 0.4);
        this.direction = new Point;
        this.position = new Point;
        this.scale = new Point;
        this.child = new Body(this);
        this.text = document.getElementById("Score");
        this.reset(pos);
    }

    createSprite(id, container) {
        const sprite = Sprite.fromFrame(id);
        sprite.anchor.set(0.5, 0.5);
        container.addChild(sprite);
        return sprite;
    }

    deleteSprite(sprite, container) {
        container.removeChild(sprite);
    };

    onRotate() {
        const angle = this.sprite.rotation - Math.PI / 2;
        this.direction.x = Math.cos(angle);
        this.direction.y = Math.sin(angle);
    }

    addChild() {
        this.speed *= 1.05;
        this.delta *= 1.05;

        let currentScale = this.c
        for (let i = 0; i < 5; i++) {
            const currentChild = this.child;
            this.child = new Body(this);

            this.child.child = currentChild;
            currentChild.parent = this.child;

            if (i == 0) {
                this.child.sprite = this.createSprite("body", this.container);
                this.child.sprite.scale.copy(this.scale);
                this.scale.set(this.scale.x + 0.01, this.scale.y + 0.01);
                this.child.sprite.position.copy(this.position);
            }
        }

        this.score++;
        this.text.innerHTML = this.score.toString();
    }

    reset(pos) {
        this.child.destroy(this);

        this.position.copy(pos);
        this.sprite.position.copy(pos);
        this.sprite.rotation = 0;
        this.speed = 70;
        this.delta = Math.PI * 0.8;
        this.turnLeft = false;
        this.score = -1;
        this.scale.set(0.3, 0.3);
        this.onRotate();
        this.addChild();
        this.addChild();
    }

    update(dt) {
        this.child.update(dt);

        /*if (input.buttonReleased("ControlLeft")) {
            this.addChild();
        }*/

        if (input.buttonReleased("Space")) {
            this.turnLeft = !this.turnLeft;
        }

        if (this.turnLeft) {
            this.sprite.rotation -= this.delta * dt;
        } else {
            this.sprite.rotation += this.delta * dt;
        }

        this.onRotate();

        this.position.set(
            this.position.x + this.direction.x * this.speed * dt,
            this.position.y + this.direction.y * this.speed * dt
        );

        this.sprite.position.copy(this.position);
    }
}

export class Body {
    constructor(parent) {
        this.parent = parent;
        this.child = null;
        this.position = new Point;
    }

    destroy(head) {
        this.child && this.child.destroy(head);

        this.sprite && head.deleteSprite(this.sprite, head.container);
        this.sprite = null;
        this.child = null;
    }

    update(dt) {
        this.child && this.child.update(dt);
        this.position.copy(this.parent.position);
        this.sprite && this.sprite.position.copy(this.position);
    }
}

export class Food {
    constructor(sprite, getPos, snake) {
        this.sprite = sprite;
        this.getPos = getPos;
        this.getPos(this.sprite.position);
        this.sprite.scale.set(0.2, 0.2);
        this.snake = snake;
        this.distance = new Point;
        this.threshold = sprite.width / 2 + snake.sprite.width / 2;
        this.threshold *= this.threshold;
    }

    update(dt) {
        this.distance.set(
            this.snake.position.x - this.sprite.position.x,
            this.snake.position.y - this.sprite.position.y
        );

        if (this.distance.x * this.distance.x + this.distance.y * this.distance.y < this.threshold) {
            //this.snake.deleteSprite(this.sprite);
            this.getPos(this.sprite.position);
            this.snake.addChild();
        }
    }
}