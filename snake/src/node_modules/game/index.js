import 'game/style.css'; // webpack magic
//import {FBInstant} from 'mock/fbinstant.6.0.mock.js'
import { Point, SCALE_MODES, settings, Sprite, Rectangle } from 'pixi.js';
settings.SCALE_MODE = SCALE_MODES.NEAREST;

import * as engine from 'engine';
import * as display from 'engine/display';
import * as resources from 'engine/resources';
import Scene from 'engine/Scene';
import { Head, Food } from 'game/Snake';

class TestScene extends Scene {
  init() {
    this.backgroundColor = 0xEEEEEE;
    const frames = Object.keys(resources.textureCache);

    const ele = document.getElementById("Root");
    ele.style.width = display.width;
    ele.style.height = display.height;

    this.character = new Head;
    this.character.createSprite = (id) => {
      const sprite = Sprite.fromFrame(id);
      sprite.anchor.set(0.5, 0.5);
      this.stage.addChild(sprite);
      return sprite;
    };

    this.character.deleteSprite = (sprite) => {
      this.stage.removeChild(sprite);
    };

    this.bound = new Rectangle(0, 0, display.width, display.height);
    const center = new Point(display.width / 2, display.height / 2);

    this.character.init(center);

    this.foods = [];
    for (let i = 0; i < 5; i++) {
      this.foods.push(new Food(this.character.createSprite("food"), (pos) => {
        pos.set(this.bound.x + Math.random() * this.bound.width,
          this.bound.y + Math.random() * this.bound.height);
      }, this.character));
    }
  }

  update(dt) {
    this.character.update(dt);

    this.foods.forEach(function (element) {
      element.update(dt);
    });

    if (!this.bound.contains(this.character.position.x, this.character.position.y)) {
      const center = new Point(display.width / 2, display.height / 2);
      this.character.reset(center);
    }
  }
}

const USE_FB_INSTANT = false;
const scene = new TestScene;

window.touchCall = function () {
  scene.character.turnLeft = !scene.character.turnLeft;
};

window.startGame = function () {
  const parentElement = document.getElementById("Root");
  engine.launch(scene, { parentElement });
}

window.onload = function () {
  if (USE_FB_INSTANT) {
    window.FBInstant.initializeAsync()
      .then(function () {
        // Start loading game assets here
        window.FBInstant.startGameAsync()
          .then(function () {
            window.startGame();
          });
      });
  } else {
    window.startGame();
  }
};