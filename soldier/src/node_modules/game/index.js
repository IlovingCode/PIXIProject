import 'game/style.css'; // webpack magic
//import {FBInstant} from 'mock/fbinstant.6.0.mock.js'
import { Point, SCALE_MODES, settings, Rectangle } from 'pixi.js';
settings.SCALE_MODE = SCALE_MODES.LINEAR;

import * as engine from 'engine';
import * as display from 'engine/display';
import Scene from 'engine/Scene';
import { Soldier, Enemy } from 'game/Soldier';

class TestScene extends Scene {
  init() {
    this.backgroundColor = 0xEEEEEE;

    const ele = document.getElementById("Root");
    ele.style.width = display.width;
    ele.style.height = display.height;

    this.bound = new Rectangle(0, 0, display.width, display.height);

    const center = new Point(display.width * 0.1, display.height * 0.8);
    this.character = new Soldier(center, this.stage);

    this.bullet = this.character.comp[3].pool;
    this.enemy = [];

    const spawnPos = new Point(display.width, display.height * 0.8);
    const color = [0xFF00FF, 0xFFFF00, 0x00FFFF];
    for (let i = 0; i < color.length; i++) {
      spawnPos.x += display.width * 0.5;
      const e = new Enemy(spawnPos, this.stage);
      e. sprite.tint = color[i];
      this.enemy.push(e);
    }

    this.score = 0;
    this.text = document.getElementById("Score");
    this.text.innerHTML = "0";
  }

  update(dt) {
    this.character.update(dt);

    this.enemy.forEach(function(element) {
      element.update(dt);
    });

    for (let i = this.bullet.length - 1; i >= 0; i--) {
      const sprite = this.bullet[i].sprite;

      if (!this.bound.contains(sprite.position.x, sprite.position.y)) {
        this.stage.removeChild(sprite);
        this.bullet[i].sprite = null;
        this.bullet.splice(i, 1);
      }

      for (let j = this.enemy.length - 1; j >= 0; j--) {
        const element = this.enemy[j];
        const r = (element.sprite.width + sprite.width) * 0.5;
        const x = element.sprite.position.x - sprite.position.x;
        const y = element.sprite.position.y - sprite.position.y;

        if (x * x + y * y < r * r) {
          element.sprite.position.copy(element.pos0);
          this.score++;
          this.text.innerHTML = this.score.toString();
        }
      }
    }
  }
}

const USE_FB_INSTANT = false;
const scene = new TestScene;

window.addEventListener('touchstart', function() {
  // the user touched the screen!
});

window.startGame = function() {
  const parentElement = document.getElementById("Root");
  engine.launch(scene, { parentElement });
};

window.postScore = function(score) {
  window.FBInstant.getLeaderboardAsync('Happy Worm.' + window.FBInstant.context.getID())
    .then((leaderboard) => {
      return leaderboard.setScoreAsync(score);
    })
    .then(() => {
      window.FBInstant.updateAsync({
        action: 'LEADERBOARD',
        name: 'Happy Worm.' + window.FBInstant.context.getID(),
      });
    });
};

window.onload = function() {
  if (USE_FB_INSTANT) {
    window.FBInstant.initializeAsync()
      .then(function() {
        // Start loading game assets here
        window.FBInstant.startGameAsync()
          .then(function() {
            window.startGame();
          });
      });
  } else {
    window.startGame();
  }
};