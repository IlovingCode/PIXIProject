import 'game/style.css'; // webpack magic
//import {FBInstant} from 'mock/fbinstant.6.0.mock.js'
import { Point, SCALE_MODES, settings, Rectangle, Graphics } from 'pixi.js';
settings.SCALE_MODE = SCALE_MODES.LINEAR;

import * as engine from 'engine';
import * as display from 'engine/display';
import Scene from 'engine/Scene';
import { Soldier, checkBound, createSprite, checkHit } from 'game/Ball';

const removeSpriteElement = function(list, id, container) {
  const e = list[id];
  container.removeChild(e.sprite);
  e.sprite = null;
  list.splice(id, 1);
};

class TestScene extends Scene {
  init() {
    this.backgroundColor = 0xEEEEEE;

    const ele = document.getElementById("Root");
    ele.style.width = display.width;
    ele.style.height = display.height;

    const delta = 0;
    this.bound = new Rectangle(-delta, -delta,
      display.width + delta * 2, display.height + delta * 2);

    const center = new Point(display.width * 0.5, display.height * 0.1);
    this.character = new Soldier(center, this.stage);

    this.obstacles = [];
    const offset = new Point(-30, display.height * 0.2);
    for (let i = 0; i < 11; i++)
      for (let j = 0; j < 11; j++) {
        const sprite = createSprite("enemy", this.stage);
        sprite.tint = 0xFF00FF;
        sprite.scale.set(0.2, 0.2);
        sprite.position.set((i % 2) * offset.x - j * offset.x * 2,
          offset.y + i * 23);
        this.obstacles.push(sprite);
      }
  }

  update(dt) {
    this.character.update(dt);

    for (let i = 0; i < this.obstacles.length; i++) {
      if (checkHit(this.obstacles[i], this.character.sprite)) {
        this.character.onHit(this.obstacles[i]);
      }
    }
  }
}

const USE_FB_INSTANT = false;
const scene = new TestScene;

window.addEventListener('touchstart', function() {
  // the user touched the screen!
});

window.startGame = function() {
  const parentElement = document.getElementById("Root");
  engine.launch(scene, { parentElement });
};

window.postScore = function(score) {
  window.FBInstant.getLeaderboardAsync('Happy Worm.' + window.FBInstant.context.getID())
    .then((leaderboard) => {
      return leaderboard.setScoreAsync(score);
    })
    .then(() => {
      window.FBInstant.updateAsync({
        action: 'LEADERBOARD',
        name: 'Happy Worm.' + window.FBInstant.context.getID(),
      });
    });
};

window.onload = function() {
  if (USE_FB_INSTANT) {
    window.FBInstant.initializeAsync()
      .then(function() {
        // Start loading game assets here
        window.FBInstant.startGameAsync()
          .then(function() {
            window.startGame();
          });
      });
  } else {
    window.startGame();
  }
};